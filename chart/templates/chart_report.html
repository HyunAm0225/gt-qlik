{% load static %}
<!DOCTYPE html>
<html lang="kr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css" integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.0/knockout-min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@1.1.1/dist/gridstack.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/gridstack@1.1.1/dist/gridstack.all.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.js"></script>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">


    <!-- API연결 -->
    <!-- <script src="https://localhost/resources/assets/external/requirejs/require.js"></script> -->
    <!-- <link rel="stylesheet" href="https://localhost/resources/autogenerated/qlik-styles.css"> -->

    <style>
      body {
        font-family: "Lato", sans-serif;
        transition: background-color .5s;
      }
      
      .sidenav {
        height: 100%;
        width: 0;
        position: fixed;
        z-index: 1;
        top: 0;
        left: 0;
        background-color: #111;
        overflow-x: hidden;
        transition: 0.5s;
        padding-top: 60px;
      }
      
      .sidenav a {
        padding: 8px 8px 8px 32px;
        text-decoration: none;
        font-size: 25px;
        color: #818181;
        display: block;
        transition: 0.3s;
      }
      
      .sidenav a:hover {
        color: #f1f1f1;
      }
      
      .sidenav .closebtn {
        position: absolute;
        top: 0;
        right: 25px;
        font-size: 36px;
        margin-left: 50px;
      }
      
      #main {
        transition: margin-left .5s;
        padding: 16px;
      }
      #bottom-main{
        transition: margin-left .5s;
      }
      @media screen and (max-height: 450px) {
        .sidenav {padding-top: 15px;}
        .sidenav a {font-size: 18px;}
      } 
      #testIframe, #testIframe2, #testIframe3, #testIframe4{
        cursor : move;
        padding : 5px;
        margin : 5px;
        height:300px;
        width:300px;
      }
      .grid-stack-item-content {
        text-align: right; /* override demo.css */
        overflow: hidden !important;
      }
      /* required file for gridstack to work */
  @import "https://cdn.jsdelivr.net/npm/gridstack@1.1.1/dist/gridstack.min.css";
  
  /* Optional styles for demos */
  .btn-primary {
    color: #fff;
    background-color: #007bff;
  }
  
  .btn {
    display: inline-block;
    padding: .375rem .75rem;
    line-height: 1.5;
    border-radius: .25rem;
  }
  
  a {
    text-decoration: none;
    cursor: pointer;
  }
  
  h1 {
    font-size: 2.5rem;
    margin-bottom: .5rem;
  }
  
  .grid-stack-item-content {
    color: #2c3e50;
    background-color: #fff;
  }

      </style>


    <script>
      function openNav() {
        document.getElementById("mySidenav").style.width = "250px";
        document.getElementById("main").style.marginLeft = "250px";
        document.getElementById("bottom-main").style.marginLeft= "250px";
      }
      
      function closeNav() {
        document.getElementById("mySidenav").style.width = "0";
        document.getElementById("main").style.marginLeft= "0";
        document.getElementById("bottom-main").style.marginLeft= "0";
        document.body.style.backgroundColor = "white";
      }

      function test() {
        $('#frame-1').toggle();
      }


      //$(function(){
       // $("#testIframe").draggable().resizable().selectable();
       // $("#testIframe2").draggable().resizable().selectable();
       // $("#testIframe3").draggable().resizable().selectable();
       // $("#testIframe4").draggable().resizable().selectable();
       // });

      

      </script>
         
    
    <title>Main Page</title>


</head>

<body>
 
  <div id="mySidenav" class="sidenav">
    <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
    
    {% if menu_list %}
      {% for menu in menu_list %}
      <a class="active" style = "cursor:pointer;" onclick="changeIframeUrl('{{ menu.url }}')" data-toggle="modal" data-target="#sheetmodal">{{ menu.title|truncatechars:30 }}</a>
      {% endfor %}
    {% else %}
        <strong>작성된 메뉴가 없습니다.</strong>
    {% endif %}


  </div>


    <!-- nav bar 시작 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      {% if user.is_authenticated %}
      <span style="font-size:30px;cursor:pointer" onclick="openNav()">&#9776;</span>
      {% endif %}
      &nbsp;&nbsp;&nbsp;
        <a class="navbar-brand" href="{% url 'home' %}">Home</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo02" aria-controls="navbarTogglerDemo02" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
      
        <div class="collapse navbar-collapse" id="navbarTogglerDemo02">
          <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
            {% if user.is_superuser %}
            <li class="nav-item">
              <a class="nav-link" href="{% url 'menu:menu_list' %}">시트 리스트</a>
            </li>
            {% endif %}
            <a class="nav-link" href="{% url 'chart:chart_report' %}">개인화 화면</a>
            <a class="nav-link" href="{% url 'chart:chart_list' %}">개인화 설정</a>

            <!-- <a class="nav-link" href="{% url 'chart:chart_report' %}">차트 분석</a> -->
          </ul>
          <!-- 로그인 성공시(시작) -->

          
          {% if user.is_authenticated %}

          <ul class="nav navbar-nav navbar-right">
            <li><a href="{% url 'update' %}" class="btn btn-outline-success"><span class="fas fa-user"></span>&nbsp;{{ user.name }} 님</a></li>
            <li>&nbsp;&nbsp;&nbsp;</li>
            <li><a href="{% url 'logout' %}" class="btn btn-outline-success"><span class="fas fa-sign-in-alt"></span>&nbsp;로그아웃</a></li>

          </ul>  	
          {% else %}

          <!-- 로그인 성공시(끝) -->

          <ul class="nav navbar-nav navbar-right">
            <li><a href="{% url 'signup' %}" class="btn btn-outline-success"><span class="fas fa-user"></span>&nbsp;회원가입</a></li>
            <li>&nbsp;&nbsp;&nbsp;</li>
            <li><a href="{% url 'login' %}" class="btn btn-outline-success"><span class="fas fa-sign-in-alt"></span>&nbsp;로그인</a></li>
            <li>&nbsp;&nbsp;&nbsp;</li>
            <!-- <li><button type="button" onclick="to_ajax()" class="btn btn-outline-success"><span class="fas fa-sign-in-alt"></span>&nbsp;테스트</button></li> -->
          </ul>  	
          {% endif %}
        </div>
      </nav>
      <!-- nav bar 끝 -->
      <!-- <div id = "main" class="jumbotron" data-bind="visible : clearGrid() || true"> -->
      <div id = "main" class="jumbotron">
        <div data-bind="component: {name: 'dashboard-grid', params: $data}"></div>
      </div>
        <!-- 숨겨진 메뉴 -->
    <div id = "bottom-main" class = "w3-bar w3-border w3-black">
    {% if chart_list %}
    {% for chart in chart_list %}
      <a class="w3-bar-item w3-button w3-hover-none w3-text-grey w3-hover-text-white" data-bind="click: addNewWidget('{{ chart.chart_url }}','{{ chart.chart_title|truncatechars:30 }}')">{{ chart.chart_title|truncatechars:30 }}</a>
    {% endfor %}
    {% else %}
        <strong>작성된 메뉴가 없습니다.</strong>
    {% endif %}
    <div class="float-right">
    <button class="w3-bar-item btn btn-lg btn-danger" data-bind="click : clearGrid">전체 삭제</a>
    <button class="w3-bar-item btn btn-lg btn-warning" data-bind="click : saveGrid">저장</a>
    </div>
    </div>
    <!-- 모달 영역 -->
    <div class="modal" id="sheetmodal" tabindex="-1" role="dialog" aria-labelledby="sheetmodal" aria-hidden="true">
      <div class="modal-body">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="background-color: white;">
          <span aria-hidden="true">&times;</span>
        </button>
        <iframe id = "sheetframe" src = 'about:blank'style="height:700px; width:100%;"></iframe>
      </div>
    </div>
    
</body>


<script type="text/javascript">
    

   function changeIframeUrl(url)				
    {
        document.getElementById("sheetframe").src = url;   
    }

    ko.components.register('dashboard-grid', {
      viewModel: {
        createViewModel: function (controller, componentInfo) {
          var ViewModel = function (controller, componentInfo) {
            var grid = null;

            this.widgets = controller.widgets;

            this.afterAddWidget = function (items) {
              if (!grid) {
                grid = GridStack.init({
                    auto: false,
                    alwaysShowResizeHandle: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
                    navigator.userAgent
                    ),
                    resizable: {
                    handles: 'e, se, s, sw, w'
                    },
                    removable: '#trash',
                    removeTimeout: 100
                });
              }

              var item = items.find(function (i) { return i.nodeType == 1 });
              grid.addWidget(item);
              ko.utils.domNodeDisposal.addDisposeCallback(item, function () {
                grid.removeWidget(item);
              });
            };
          };

          return new ViewModel(controller, componentInfo);
        }
      },
      template:
        [
          '<div class="grid-stack" data-bind="foreach: {data: widgets, afterRender: afterAddWidget}">',
          '   <div class="grid-stack-item" data-bind="attr: {\'data-gs-x\': $data.x, \'data-gs-y\': $data.y, \'data-gs-width\': $data.width, \'data-gs-height\': $data.height, \'data-gs-auto-position\': $data.auto_position}">',
          '     <div class="grid-stack-item-content"><a class="float-right" data-bind="click: $root.deleteWidget"><i class="fas fa-times"></i></a><center style="cursor:move;"><h5 data-bind="text: index" /></center><iframe data-bind="attr : {src : url}" style="width:100%;height:90%; border:none;"></iframe></div>',
          '   </div>',
          '</div> '
        ].join('')
    });


    var Controller = function (widgets) {
      var self = this;

      this.widgets = ko.observableArray(widgets);

      this.addNewWidget = function (iframe_url,name) {
        this.widgets.push({
          x: 0,
          y: 0,
          width: 4,
          height: 5,
          auto_position: true,
          index: name,
          url : iframe_url
        });
        return false;
      };
      

      this.deleteWidget = function (item) {
        self.widgets.remove(item);
        return false;
      };

      this.clearGrid = function(){
        this.widgets.removeAll();
        return false;
      };
      
      this.loadGrid = function(){
        this.widgets.removeAll();
        var items = GridStack.utils.sort(serializedData);
        this.widgets.batchUpdate();
        items.forEach(function (node){
          this.widgets.addWidget(
            '<div class="grid-stack" data-bind="foreach: {data: widgets, afterRender: afterAddWidget}">',
              '   <div class="grid-stack-item" data-bind="attr: {\'data-gs-x\': $data.x, \'data-gs-y\': $data.y, \'data-gs-width\': $data.width, \'data-gs-height\': $data.height, \'data-gs-auto-position\': $data.auto_position}">',
              '     <div class="grid-stack-item-content"><a class="float-right" data-bind="click: $root.deleteWidget"><i class="fas fa-times"></i></a><center style="cursor:move;"><h5 data-bind="text: index" /></center><iframe data-bind="attr : {src : url}" style="width:100%;height:90%; border:none;"></iframe></div>',
              '   </div>',
              '</div> ',node
          );
        });
          this.widgets.commit();
      };

      this.saveGrid = function(){
        this.widgets = [];
        this.widgets.engine.nodes.forEach(function(node){
          this.widgets.push({
            x: node.x,
            y: node.y,
            width: node.width,
            height: node.height,
            auto_position: true,
            index: node.name,
            url : node.iframe_url
          });
        });
        document.querySelector('#saved-data').value = JSON.stringify(this.widgets, null, ' ');
      };
      
    };




    var widgets = [
      
    ];

    var controller = new Controller(widgets);
    ko.applyBindings(controller);

    /* API로 Qlik에 접근하는 방법 */
      /*
      var config = {
        host: 'localhost',
        prefix: "/",
        port: 443,
        isSecure: true
      };
      require.config( {
        baseUrl: ( config.isSecure ? "https://" : "http://" ) + config.host + (config.port ? ":" + config.port : "") + config.prefix + "resources"
      } );
      
      require( ["js/qlik"], function ( qlik ) {
        qlik.on( "error", function ( error ) {
          $( '#popupText' ).append( error.message + "<br>" );
          $( '#popup' ).fadeIn( 1000 );
        } );
      
        //callbacks -- inserted here --
        //open apps -- inserted here --
        var app = qlik.openApp('961cc50a-b528-4d4a-bb24-f45e3c1df631', config);
        //console.log(app)
        var app1 = qlik.openApp('029b3b85-6c96-4c0c-bbf2-abe93b2efc04', config);
        //get objects -- inserted here --
        app.getObject('QV01','qPyMBp');
        app.getObject('QV02','FtPJzy');
        app.getObject('QV03','SKnzKQ');
        app.getObject('QV04','JQtPpt');
        app.getObject('QV05','TFWPC');
        app.getObject('QV06','gnaeYX');
        app1.getObject('QV07','QGKNm');
        app1.getObject('QV08','NMUWBzE');
        
        //create cubes and lists -- inserted here --
      
      } );
      */

</script>


</html>



<!-- 
<div id="draggable1" class="ui-widget-content">
  <iframe id="Iframe1" width="100%" height="100%"  frameBorder="0" src="https://localhost/single/?appid=c1d417cc-5c5e-4b31-9b1e-07607e081d29&obj=aayfNc&opt=ctxmenu,currsel"></iframe>
</div> -->